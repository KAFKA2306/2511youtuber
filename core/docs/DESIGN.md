# 設計仕様書

## ディレクトリ構成
```
core/
├── docs/               # 要求・設計ドキュメント
├── src/
│   ├── main.py         # CLIエントリーポイント
│   ├── workflow.py     # ワークフロー制御
│   ├── news.py         # ニュース取得プロバイダ
│   ├── script.py       # Gemini応答処理
│   ├── audio.py        # 音声合成
│   ├── video.py        # 映像生成
│   └── settings.py     # 単一設定オブジェクト
└── tests/
    ├── test_workflow.py
    ├── test_script.py
    └── fixtures/
```

## アーキテクチャ
- `settings.Settings`: 依存注入の単一入口。必要なキーのみ保持し、辞書アクセスに限定。
- `workflow.Workflow`: 4段ステップを直列実行。各ステップは`run()`を公開し、成功パスのみ返却。
- 各モジュールは関数ベースで実装し、状態は入力引数と戻り値のみに閉じ込める。
- アーティファクトは`artifacts/{step}`配下に保存。ワークフロー開始時にルートを生成し、ステップ名でファイルを固定。

## Gemini応答処理
- `script.generate(news, llm, template)`が唯一のLLM境界。Geminiへのプロンプトはテンプレート化し、温度やアウトライン長は設定で制御。
- 応答はJSONで受け取り、`validate(parsed)`でキー存在と文字数制約のみ確認。失敗時はそのまま例外を送出し、再試行は行わない。
- 台本は`segments`配列に整形し、音声・字幕モジュールが共有する。

## 関心の分離
- ニュース取得はダミー実装から開始し、HTTP依存はラッパ関数に限定。
- 音声合成は単一関数でテキスト→WAVを扱い、後から別エンジンに差し替え可能。
- 映像生成はFFmpegコマンドラッパを提供し、テンプレート定義ファイルで背景・字幕スタイルを決定。

## テスト戦略
- ユニット: 各モジュールの純粋関数性を検証。
- ワークフロー: ステップ間の引数交換とアーティファクト生成を検証。
- LLMモック: Gemini応答テンプレートを`tests/fixtures/gemini_response.json`に保持し、決定的な検証を行う。

## DRIルール
- それぞれのモジュール所有者がレビューを担当し、所有者不在時はCore Maintainerが代理。
- 新機能は関連するテストの更新が完了してからマージする。

## コーディングポリシー
- エラーハンドリングとコメントは禁止。成功パスが保証されるパラメータと前提条件を設計側で満たす。
- ファイルは極力200行以下。複雑な処理はモジュール分割で対応。
