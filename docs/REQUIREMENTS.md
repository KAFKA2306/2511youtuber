# 要求仕様書 - YouTube AI Video Generator v2

**プロジェクト名**: YouTube AI Video Generator v2
**作成日**: 2025-10-10
**バージョン**: 2.0.0
**ステータス**: 新規設計

---

## 1. プロジェクトの目的

金融ニュースから高品質な日本語YouTube動画を自動生成し、視聴維持率50%以上を達成する。

**前プロジェクトの失敗からの教訓**:
- 13ステップの逐次パイプラインは単一障害点が多すぎる
- 6つの外部API依存により不安定性が蓄積
- エラーハンドリング除去により脆弱性が増大
- テストカバレッジ不足により回帰バグが頻発
- 統合テストゼロで本番環境＝テスト環境化

---

## 2. 核心機能（MVP）

### 2.1 必須機能（Phase 1: 2週間）

1. **ニュース収集** - 金融ニュース3件取得
2. **スクリプト生成** - LLMによる3話者対話形式スクリプト
3. **音声合成** - 話者別TTS（最低1プロバイダ動作保証）
4. **動画生成** - 字幕付き単色背景動画
5. **ローカル保存** - 生成物をファイルシステムに永続化

**スコープ外（Phase 1）**:
- YouTube自動アップロード
- Google Sheets連携
- B-roll映像
- サムネイル生成
- フィードバックループ
- 複雑な映像エフェクト

### 2.2 オプション機能（Phase 2以降）

- YouTube API統合（独立モジュール）
- メタデータ分析（独立モジュール）
- 映像エフェクト拡張（プラグイン方式）

---

## 3. 非機能要求

### 3.1 信頼性

| 項目 | 要求 | 前プロジェクトの失敗 |
|------|------|---------------------|
| **ワークフロー成功率** | 95%以上 | 20%（4/5失敗） |
| **障害の影響範囲** | 単一ステップのみ | 全ステップ停止 |
| **部分的成功** | 可能（保存済みステップはスキップ） | 不可能（最初からやり直し） |
| **外部API障害時** | フォールバック動作継続 | ワークフロー停止 |

### 3.2 保守性

- **モジュール独立性**: 各コンポーネントは他に依存せず差し替え可能
- **設定外部化**: すべての設定をYAMLファイルに集約
- **ロギング**: 構造化ログ（JSON形式）でデバッグ容易性確保
- **テストカバレッジ**: 80%以上（前プロジェクト: 推定30%）

### 3.3 拡張性

- **プラグイン方式**: TTS/LLM/動画エフェクトはプラグインで追加可能
- **設定駆動**: 新規プロバイダは設定追加のみで利用可能
- **API変更耐性**: プロバイダインターフェース統一によりAPI変更を局所化

---

## 4. システム制約

### 4.1 技術スタック

- **言語**: Python 3.11+
- **依存管理**: uv（前プロジェクトと同じ）
- **設定**: YAML + Pydantic
- **テスト**: pytest
- **LLM**: Google Gemini API（LiteLLM経由）
- **TTS**: VOICEVOX（無料・高品質）をデフォルト
- **動画生成**: FFmpeg 4.4+

### 4.2 外部API依存の最小化方針

| API | 用途 | 必須性 | フォールバック |
|-----|------|--------|--------------|
| Gemini | スクリプト生成 | 必須 | ダミースクリプト |
| VOICEVOX | 音声合成 | 推奨 | pyttsx3（オフライン） |
| Perplexity | ニュース収集 | オプション | NewsAPI → ダミーニュース |

**設計原則**: 外部API障害時もワークフローは完遂する

---

## 5. データモデル

### 5.1 スクリプト構造

```python
ScriptSegment:
  speaker: str          # 春日部つむぎ | ずんだもん | 玄野武宏
  text: str            # 発話内容
  start_time: float    # 開始時刻（秒）
  end_time: float      # 終了時刻（秒）
```

### 5.2 ワークフロー状態

```python
WorkflowState:
  run_id: str                    # 実行ID
  status: "running" | "completed" | "failed"
  completed_steps: List[str]     # 完了済みステップ名
  outputs: Dict[str, Path]       # 各ステップの出力ファイルパス
  errors: List[str]              # エラーログ
```

---

## 6. ワークフロー設計

### 6.1 ステップ構成（5ステップ）

前プロジェクトの13ステップから8ステップ削減:

1. **ニュース収集** (`collect_news`)
2. **スクリプト生成** (`generate_script`)
3. **音声合成** (`synthesize_audio`)
4. **字幕整形** (`prepare_subtitles`)
5. **動画生成** (`render_video`)

### 6.2 実行方針

- **チェックポイント方式**: 各ステップ完了時にファイル保存
- **冪等性**: 同じrun_idで再実行時、完了済みステップはスキップ
- **独立性**: ステップ間は保存ファイルのみで連携（メモリ共有なし）

**前プロジェクトとの違い**:
```python
# 前プロジェクト（脆弱）:
for step in steps:
    result = await step.execute()
    if not result.success:
        return FAILURE  # すべて破棄

# 新プロジェクト（堅牢）:
for step in steps:
    if step.output_exists():
        continue  # スキップ
    try:
        step.execute()
        step.save_output()
    except Exception as e:
        log_error(e)
        if step.is_critical:
            break  # 他のステップの成果物は保持
```

---

## 7. 品質要求

### 7.1 スクリプト品質

- **言語**: 日本語中心（英語混在可）
- **長さ**: 5-10分（音声合成後）
- **話者交代**: 最低10回（単調さ回避）
- **WOWスコア**: 6.0以上（前プロジェクトの8.0は過剰）

### 7.2 音声品質

- **サンプリングレート**: 24kHz以上
- **形式**: WAV（可逆）
- **話者識別性**: 3話者が明確に区別可能

### 7.3 動画品質

- **解像度**: 1920x1080（Full HD）
- **フレームレート**: 25fps
- **字幕**: 見やすいフォント・配色
- **音声同期**: ±100ms以内

---

## 8. エラーハンドリング方針

前プロジェクトの致命的失敗の反省:

### 8.1 原則

1. **エラーハンドリングは邪悪**
2. **外部API呼び出しは必ずtry-catchで囲む**
3. **ログ出力は明確に**（何が失敗したか、なぜ失敗したか、次のアクションは何か）
4. **リトライロジック**: 0回
5. **フォールバック**: APIのレートリミットにのみ実装を許容される

### 8.2 エラーレベル定義

- **CRITICAL**: ワークフロー続行不可（例: Gemini API全キー枯渇）
- **ERROR**: 当該ステップ失敗だが他ステップは続行可能（例: YouTube API失敗）
- **WARNING**: 品質劣化だが機能する（例: TTS品質低下）
- **INFO**: 正常動作（例: キャッシュヒット）

---

## 9. テスト要求

前プロジェクトの失敗: 実際のLLM APIを実用したテストの未実施によるLLM API出力のフォーマット崩れの検出不足

### 9.1 必須テストカバレッジ

- **ユニットテスト**: 各関数・クラスの単体動作
- **統合テスト**: ステップ間連携（実LLM API使用）
- **E2Eテスト**: 実API使用（CI/CD実行時のみ）

### 9.2 テスト実行ポリシー

```bash
# コミット前（必須）
pytest tests/unit -v

# PR前（必須）
pytest tests/unit tests/integration -v

# リリース前（必須）
pytest --run-e2e -v
```

---

## 10. 成功基準

### Phase 1完了条件（MVP）

- [ ] 5ステップのワークフロー動作
- [ ] ローカルファイルに動画保存成功
- [ ] ユニットテスト80%カバレッジ達成
- [ ] 統合テスト10件以上作成
- [ ] 3回連続でワークフロー成功（成功率100%）

### Phase 1で達成しないもの

- YouTube自動アップロード
- 高度な映像エフェクト
- フィードバックループ分析
- Google Sheets連携

**理念**: "動く最小システム"を確実に作り、そこから拡張する

---

## 11. 前プロジェクトの失敗分析

### 11.1 技術的失敗

1. **13ステップ逐次パイプライン** → 単一障害点13個
2. **6外部API依存** → 複合障害率高
3. **暗黙的API契約** → Google Sheets `A:Z` vs `A1` バグ

### 11.2 プロセス失敗

1. **コミット前検証なし** → 未コミット変更が本番破壊
2. **CI/CDなし** → 本番＝テスト環境
3. **ドキュメント不足** → API仕様理解不足でバグ混入

### 11.3 設計失敗

1. **レジリエンス設計なし** → 単一障害が全体停止を引き起こす
2. **密結合** → コンポーネント差し替え不可
3. **機能過多** → 13ステップは複雑すぎ

---

## 12. 新プロジェクトの設計原則

### 12.1 SOLID原則の徹底

- **S**: 各モジュールは単一責任
- **O**: 拡張に開いて変更に閉じる（プラグイン方式）
- **L**: インターフェース統一（TTS/LLMプロバイダ）
- **I**: 細かいインターフェース分離
- **D**: 具象クラスではなくインターフェースに依存

### 12.2 関心の分離

- ワークフロー制御 ≠ ビジネスロジック
- データ取得 ≠ データ変換 ≠ データ保存
- 設定 ≠ 実装

### 12.3 DRY原則

- 重複コード排除
- 設定の一元化
- 共通処理のユーティリティ化

### 12.4 フェイルファスト vs フェイルセーフ

- **開発時**: フェイルファスト（早期エラー検出）
- **本番時**: フェイルセーフ（部分的成功を保証）

---

## 13. 開発スケジュール（推定）

| Phase | 期間 | 成果物 |
|-------|------|--------|
| Phase 0 | 1日 | 要求仕様書・設計仕様書 |
| Phase 1 | 2週間 | MVP（5ステップワークフロー） |
| Phase 2 | 1週間 | YouTube統合・メタデータ分析 |
| Phase 3 | 1週間 | 映像エフェクト・サムネイル生成 |

**Phase 1に集中**: まず動く最小システムを完成させる

---

## 14. 付録: 用語集

- **MVP**: Minimum Viable Product（実用最小限の製品）
- **フォールバック**: 障害時の代替動作
- **冪等性**: 同じ操作を複数回実行しても結果が同じ
- **チェックポイント**: 実行状態の保存ポイント
- **フェイルセーフ**: 障害時も安全動作を保証する設計

---

**承認**: 未承認（ドラフト）
**次のアクション**: 設計仕様書作成
